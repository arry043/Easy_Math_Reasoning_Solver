name: Sync to Hugging Face hub

on:
  push:
    branches: [main]

  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Configure Git
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

      - name: Add Hugging Face remote
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Add remote with token (idempotent)
          git remote remove hf || true
          git remote add hf https://arry03:$HF_TOKEN@huggingface.co/spaces/arry03/Easy_MR_Solver
          git fetch hf main

      - name: Merge Hugging Face changes (auto-resolve, prefer GitHub)
        # This will merge HF's main into the checked-out GH main.
        # -X ours makes sure local (GitHub) version wins conflicts.
        run: |
          set -e
          # If histories are unrelated, allow unrelated histories to merge.
          # We merge FETCH_HEAD (hf/main) into our local main.
          git merge --no-edit -X ours --allow-unrelated-histories hf/main || true

          # If merge produced conflicts, automatically add and commit (we prefer local)
          if [ -n "$(git ls-files -u)" ]; then
            echo "Conflicts detected â€” auto-resolving by preferring local (GitHub) files."
            # Stage everything (local files already preferred via -X ours)
            git add -A
            # If no changes to commit, skip
            if ! git diff --staged --quiet; then
              git commit -m "CI: auto-resolve merge conflicts preferring GitHub (Actions)"
            fi
          fi

      - name: Push to Hugging Face hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Push the merged result to HF
          git push https://arry03:$HF_TOKEN@huggingface.co/spaces/arry03/Easy_MR_Solver main
